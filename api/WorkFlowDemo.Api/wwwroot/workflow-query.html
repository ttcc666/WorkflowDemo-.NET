<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>流程查询</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link href="css/site.css" rel="stylesheet" />
    </head>
    <body>
        <div class="container py-4">
            <div class="main-container">
                <div
                    class="d-flex justify-content-between align-items-center mb-4"
                >
                    <h1 class="page-title mb-0">
                        <i class="bi bi-clock-history text-primary"></i>
                        流程查询
                    </h1>
                    <a href="index.html" class="btn btn-outline-secondary">
                        <i class="bi bi-house me-2"></i>返回首页
                    </a>
                </div>

                <div class="d-flex gap-2 mb-4">
                    <button class="btn btn-gradient" onclick="loadWorkflows()">
                        <i class="bi bi-arrow-clockwise me-2"></i>刷新
                    </button>
                </div>

                <div id="loading" class="loading-state" style="display: none">
                    <i class="bi bi-hourglass-split"></i>
                    <p>加载中...</p>
                </div>

                <div id="empty" class="empty-state" style="display: none">
                    <i class="bi bi-inbox"></i>
                    <p>暂无数据</p>
                </div>

                <div id="tableContainer" style="display: none">
                    <div class="table-responsive">
                        <table class="table table-hover custom-table">
                            <thead>
                                <tr>
                                    <th>批号</th>
                                    <th>操作员</th>
                                    <th>创建时间</th>
                                    <th>物料种类</th>
                                    <th>总数量</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="workflowBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详情模态框 -->
        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-file-text me-2"></i>批次详情
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="text-muted small mb-1">
                                        <i class="bi bi-tag-fill me-1"></i>批号
                                    </div>
                                    <div
                                        class="fw-bold fs-6"
                                        id="detailBatchNumber"
                                    ></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="text-muted small mb-1">
                                        <i class="bi bi-person-fill me-1"></i
                                        >操作员
                                    </div>
                                    <div
                                        class="fw-bold fs-6"
                                        id="detailOperator"
                                    ></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <div class="text-muted small mb-1">
                                        <i class="bi bi-clock-fill me-1"></i
                                        >创建时间
                                    </div>
                                    <div
                                        class="fw-bold fs-6"
                                        id="detailCreateTime"
                                    ></div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 fw-semibold">
                            <i class="bi bi-list-check me-2"></i>物料明细
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th
                                            class="text-center"
                                            style="width: 80px"
                                        >
                                            序号
                                        </th>
                                        <th>物料代码</th>
                                        <th
                                            class="text-center"
                                            style="width: 120px"
                                        >
                                            数量
                                        </th>
                                        <th style="width: 180px">操作时间</th>
                                    </tr>
                                </thead>
                                <tbody id="detailItemsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/site.js"></script>
        <script>
            const API_BASE = "/WorkflowQuery";
            let detailModalInstance;

            async function loadWorkflows() {
                const tableContainer =
                    document.getElementById("tableContainer");
                const tbody = document.getElementById("workflowBody");

                showLoading(true);
                showEmpty(false);
                tableContainer.style.display = "none";

                try {
                    const response = await fetch(`${API_BASE}/GetAllWorkflows`);
                    const result = await response.json();

                    showLoading(false);

                    if (
                        result.code === 200 &&
                        result.data &&
                        result.data.length > 0
                    ) {
                        tbody.innerHTML = result.data
                            .map(
                                (workflow) => `
                        <tr>
                            <td><strong>${workflow.batchNumber}</strong></td>
                            <td>${workflow.operator_}</td>
                            <td>${formatDateTime(workflow.creatimeTime)}</td>
                            <td>
                                <span class="badge bg-info badge-custom">${workflow.itemCount} 种</span>
                            </td>
                            <td>
                                <span class="badge bg-primary badge-custom">${workflow.totalQty}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-gradient" onclick="showWorkflowDetail('${workflow.batchNumber}')">
                                    <i class="bi bi-eye me-1"></i>查看详情
                                </button>
                            </td>
                        </tr>
                    `,
                            )
                            .join("");
                        tableContainer.style.display = "block";
                    } else {
                        showEmpty(true);
                    }
                } catch (error) {
                    showLoading(false);
                    showMessage("加载失败：" + error.message, "error");
                }
            }

            async function showWorkflowDetail(batchNumber) {
                try {
                    const response = await fetch(
                        `${API_BASE}/GetWorkflowByBatch?batchNumber=${encodeURIComponent(batchNumber)}`,
                    );
                    const result = await response.json();

                    if (result.code === 200 && result.data) {
                        const data = result.data;

                        document.getElementById(
                            "detailBatchNumber",
                        ).textContent = data.batchNumber;
                        document.getElementById("detailOperator").textContent =
                            data.operator_;
                        document.getElementById(
                            "detailCreateTime",
                        ).textContent = formatDateTime(data.creatimeTime);

                        const itemsBody =
                            document.getElementById("detailItemsBody");
                        itemsBody.innerHTML = data.items
                            .map(
                                (item, index) => `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td><strong>${item.materialCode}</strong></td>
                            <td class="text-center"><span class="badge bg-success rounded-pill px-3">${item.qty}</span></td>
                            <td><small>${formatDateTime(item.operationTime)}</small></td>
                        </tr>
                    `,
                            )
                            .join("");

                        detailModalInstance = new bootstrap.Modal(
                            document.getElementById("detailModal"),
                        );
                        detailModalInstance.show();
                    } else {
                        showMessage(
                            "获取详情失败：" + (result.message || "未知错误"),
                            "error",
                        );
                    }
                } catch (error) {
                    showMessage("获取详情失败：" + error.message, "error");
                }
            }

            window.onload = () => loadWorkflows();
        </script>
    </body>
</html>
